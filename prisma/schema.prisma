generator client {
  provider = "prisma-client-js"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

model Category {
  id          String     @id @default(uuid())
  name        String
  description String?
  parentId    String?
  parent      Category?  @relation("CategoryToCategory", fields: [parentId], references: [id])
  children    Category[] @relation("CategoryToCategory")
  products    Product[]
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
}

model Product {
  id            String        @id @default(uuid())
  name          String
  description   String?
  sku           String        @unique
  barcode       String?
  unit          String // pcs, kg, etc.
  costPrice     Float
  sellingPrice  Float
  taxRate       Float?        @default(0)
  reorderLevel  Int           @default(0)
  status        String        @default("ACTIVE") // ACTIVE, INACTIVE
  categoryId    String?
  category      Category?     @relation(fields: [categoryId], references: [id])
  supplierId    String? // Link to Supplier
  variants      Variant[]
  ledgerEntries StockLedger[]
  saleItems     SaleItem[]
  purchaseItems PurchaseItem[]
  onlineOrderItems OnlineOrderItem[]
  stockTransferItems StockTransferItem[]
  isDeleted     Boolean       @default(false)
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
}

model Variant {
  id            String     @id @default(uuid())
  productId     String
  product       Product    @relation(fields: [productId], references: [id], onDelete: Cascade)
  name          String // e.g., "Size: L", "Color: Blue"
  sku           String     @unique
  barcode       String?
  costPrice     Float? // Override
  sellingPrice  Float? // Override
  stockQuantity Int        @default(0)
  saleItems     SaleItem[]
  isDeleted     Boolean    @default(false)
  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt
}

model Warehouse {
  id            String        @id @default(uuid())
  name          String
  location      String?
  ledgerEntries StockLedger[]
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  sales         Sale[]
  purchases     Purchase[]
  sourceTransfers StockTransfer[] @relation("SourceWarehouse")
  destTransfers   StockTransfer[] @relation("DestWarehouse")
}

model StockTransfer {
  id              String             @id @default(uuid())
  transferNumber  String             @unique
  sourceWarehouseId String
  sourceWarehouse Warehouse          @relation("SourceWarehouse", fields: [sourceWarehouseId], references: [id])
  destWarehouseId String
  destWarehouse   Warehouse          @relation("DestWarehouse", fields: [destWarehouseId], references: [id])
  date            DateTime           @default(now())
  status          String             @default("COMPLETED") // COMPLETED, CANCELLED
  notes           String?
  items           StockTransferItem[]
  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @updatedAt
}

model StockTransferItem {
  id              String        @id @default(uuid())
  transferId      String
  transfer        StockTransfer @relation(fields: [transferId], references: [id], onDelete: Cascade)
  productId       String
  product         Product       @relation(fields: [productId], references: [id])
  quantity        Int
}

model StockLedger {
  id             String    @id @default(uuid())
  productId      String
  product        Product   @relation(fields: [productId], references: [id])
  variantId      String?
  warehouseId    String
  warehouse      Warehouse @relation(fields: [warehouseId], references: [id])
  quantityChange Int // Positive for IN, negative for OUT
  type           String // PURCHASE, SALE, RETURN, ADJUSTMENT, TRANSFER
  referenceId    String? // ID of the order/transaction
  note           String?
  userId         String
  createdAt      DateTime  @default(now())
}

model Party {
  id             String   @id @default(uuid())
  name           String
  type           String // SUPPLIER, CUSTOMER, BOTH
  phone          String
  email          String?
  address        String
  openingBalance Float    @default(0)
  currentBalance Float    @default(0)
  status         String   @default("ACTIVE") // ACTIVE, INACTIVE
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  ledgers  PartyLedger[]
  payments Payment[]
  sales    Sale[]
  purchases Purchase[]
}

model Payment {
  id        String   @id @default(uuid())
  partyId   String
  party     Party    @relation(fields: [partyId], references: [id], onDelete: Cascade)
  amount    Float
  method    String // CASH, BANK, MOBILE_MONEY
  type      String // PAYMENT_MADE, PAYMENT_RECEIVED, ADVANCE
  reference String?
  date      DateTime
  note      String?
  createdAt DateTime @default(now())

  ledgers PartyLedger[]
  accountId String?
  account   Account? @relation(fields: [accountId], references: [id])
  saleId    String?
  sale      Sale?    @relation(fields: [saleId], references: [id])
  purchaseId String?
  purchase   Purchase? @relation(fields: [purchaseId], references: [id])
}

model PartyLedger {
  id             String   @id @default(uuid())
  partyId        String
  party          Party    @relation(fields: [partyId], references: [id], onDelete: Cascade)
  paymentId      String?
  payment        Payment? @relation(fields: [paymentId], references: [id])
  transactionId  String?
  date           DateTime
  description    String
  type           String // DEBIT or CREDIT
  amount         Float
  runningBalance Float
  createdAt      DateTime @default(now())
}

model Sale {
  id             String     @id @default(uuid())
  saleNumber     String     @unique
  customerId     String
  customer       Party      @relation(fields: [customerId], references: [id])
  warehouseId    String
  warehouse      Warehouse  @relation(fields: [warehouseId], references: [id])
  totalAmount    Float // Gross total
  discountAmount Float      @default(0)
  taxAmount      Float      @default(0)
  netAmount      Float // Final total
  paidAmount     Float      @default(0)
  balanceAmount  Float      @default(0)
  paymentStatus  String // PAID, PARTIAL, UNPAID
  status         String     @default("COMPLETED") // COMPLETED, CANCELLED, RETURNED
  userId         String
  notes          String?
  items          SaleItem[]
  invoice        Invoice?
  payments       Payment[]
  createdAt      DateTime   @default(now())
  updatedAt      DateTime   @updatedAt
}

model SaleItem {
  id             String   @id @default(uuid())
  saleId         String
  sale           Sale     @relation(fields: [saleId], references: [id], onDelete: Cascade)
  productId      String
  product        Product  @relation(fields: [productId], references: [id])
  variantId      String?
  variant        Variant? @relation(fields: [variantId], references: [id])
  quantity       Int
  returnedQuantity Int    @default(0)
  unitPrice      Float
  discountAmount Float    @default(0)
  taxAmount      Float    @default(0)
  totalAmount    Float // quantity * unitPrice - discount + tax
}

model Invoice {
  id            String   @id @default(uuid())
  saleId        String   @unique
  sale          Sale     @relation(fields: [saleId], references: [id], onDelete: Cascade)
  invoiceNumber String   @unique
  invoiceDate   DateTime @default(now())
  totalAmount   Float
  pdfUrl        String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

model Purchase {
  id             String         @id @default(uuid())
  purchaseNumber String         @unique
  supplierId     String
  supplier       Party          @relation(fields: [supplierId], references: [id])
  warehouseId    String
  warehouse      Warehouse      @relation(fields: [warehouseId], references: [id])
  totalAmount    Float
  taxAmount      Float          @default(0)
  netAmount      Float
  paidAmount     Float          @default(0)
  balanceAmount  Float          @default(0)
  status         String         @default("COMPLETED") // PENDING, RECEIVED, COMPLETED
  paymentStatus  String         @default("UNPAID")
  date           DateTime       @default(now())
  notes          String?
  items          PurchaseItem[]
  payments       Payment[]
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt
}

model PurchaseItem {
  id         String   @id @default(uuid())
  purchaseId String
  purchase   Purchase @relation(fields: [purchaseId], references: [id], onDelete: Cascade)
  productId  String
  product    Product  @relation(fields: [productId], references: [id])
  quantity   Int
  unitCost   Float
  totalCost  Float
}

model ExpenseCategory {
  id          String    @id @default(uuid())
  name        String
  description String?
  expenses    Expense[]
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
}

model Expense {
  id           String          @id @default(uuid())
  categoryId   String
  category     ExpenseCategory @relation(fields: [categoryId], references: [id])
  amount       Float
  date         DateTime        @default(now())
  description  String?
  reference    String?
  paidBy       String? // User who paid
  paymentMethod String? // CASH, BANK
  accountId    String?
  account      Account?        @relation(fields: [accountId], references: [id])
  createdAt    DateTime        @default(now())
  updatedAt    DateTime        @updatedAt
}

model Account {
  id            String    @id @default(uuid())
  name          String
  type          String    // CASH, BANK, MOBILE_MONEY
  accountNumber String?
  balance       Float     @default(0)
  currency      String    @default("USD")
  description   String?
  isDefault     Boolean   @default(false)
  expenses      Expense[]
  payments      Payment[]
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
}

model OnlineOrder {
  id              String            @id @default(uuid())
  orderNumber     String            @unique
  customerName    String
  customerEmail   String
  customerPhone   String
  shippingAddress String
  totalAmount     Float
  status          String            @default("PENDING") // PENDING, CONFIRMED, SHIPPED, DELIVERED, CANCELLED
  items           OnlineOrderItem[]
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
}

model OnlineOrderItem {
  id            String      @id @default(uuid())
  onlineOrderId String
  onlineOrder   OnlineOrder @relation(fields: [onlineOrderId], references: [id], onDelete: Cascade)
  productId     String
  product       Product     @relation(fields: [productId], references: [id])
  quantity      Int
  unitPrice     Float
  totalPrice    Float
}

model SubscriptionPlan {
  id          String   @id @default(uuid())
  name        String // Basic, Pro, Enterprise
  price       Float
  duration    Int // Days
  features    String // JSON or comma-separated
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  isActive    Boolean  @default(true)
  settings    Settings[]
}

model Settings {
  id           String   @id @default(uuid())
  businessName String
  address      String?
  phone        String?
  email        String?
  currency     String   @default("USD")
  taxRate      Float    @default(0)
  subscriptionPlanId String?
  subscriptionPlan SubscriptionPlan? @relation(fields: [subscriptionPlanId], references: [id])
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
}
